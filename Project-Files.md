Project files are how you tell Evergreen what to do.
They contain a set of tasks and variants to run those tasks on, and are stored within the repository they test.
Project files are written in a simple YAML config language.

## Examples
Before reading onward, you should check out some example project files:

1. [Sample tutorial project file](https://github.com/evergreen-ci/sample.git)
2. [Evergreen's own project file](https://github.com/evergreen-ci/evergreen/blob/master/self-tests.yml)
3. [The MongoDB Tools project file](https://github.com/mongodb/mongo-tools/blob/master/common.yml)
4. [The MongoDB Server project file](https://github.com/mongodb/mongo/blob/master/etc/evergreen.yml)

Though some of them are quite large, the pieces that make them up are very simple.

## Basic Features

### Tasks
A task is any discrete job you want Evergreen to run, typically a build, test suite, or deployment of some kind.
A task is made up of a list of commands/functions.
Currently we include commands for interacting with git, running shell scripts, parsing test results, and manipulating Amazon s3.

For example, a couple tasks might look like:
```yaml
tasks:
- name: compile
  depends_on: []
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "compile and upload to s3" 
- name: passing_test 
  depends_on: 
  - name: compile
  commands:
    - func: "download compiled artifacts"
    - func: "run a task that passes"
```

Notice that each task contains:

1. A name
2. A set of dependencies of other tasks
3. A list of commands and/or functions

### Commands
Commands are the building blocks of tasks.
Each command has a set of parameters that it can take.

####shell.exec
This command runs a shell script.

```yaml
- command: shell.exec
  params:
    working_dir: src
    script: |
      echo "this is a 2nd command in the function!"
      ls
```

Parameters:
* `script`: the script to run 
* `working_dir`: the directory to execute the shell script in
* `background`: if set to true, does not wait for the script to exit before running the next commands
* `silent`: if set to true, does not log any shell output during execution; useful to avoid leaking sensitive info
* `continue_on_err`: if set to true, causes command to exit with success regardless of the script's exit code

####shell.track
This command starts up process tracking so that all started processes get cleaned up on task completion.
Used with `shell.cleanup`.

```yaml
- command: shell.track
```
This function takes no parameters.

####shell.cleanup
This command cleans up all process trees created during execution.
Used with `shell.track`.

```yaml
- command: shell.cleanup
```
This function takes no parameters.

####git.get_project
This command clones the tracked project repository into a given directory.

NOTE: this command currently only supports clone over SSH.
Make sure your keys are set up //TODO

```yaml
- command: git.get_project
  params:
    directory: src
```

Parameters:
* `dir`: the directory to clone into

####git.apply_patch
Applies a user patch to the tracked project in the given directory.

NOTE: This will be rolled into the `git.get_project` command by `1.0.0`.

```yaml
- command: git.apply_patch
  params:
    directory: src
```

Parameters:
* `dir`: the directory to apply the diff in (same as `git.get_project`)

####s3.put
This command uploads a file to Amazon s3, for use in later tasks or distribution.

```yaml
- command: s3.put
  params:
    aws_key: ${aws_key}
    aws_secret: ${aws_secret}
    local_file: src/mongodb-binaries.tgz
    remote_file: mongodb-mongo-master/${build_variant}/${revision}/binaries/mongo-${build_id}.${ext|tgz}
    bucket: mciuploads
    permissions: public-read
    content_type: ${content_type|application/x-gzip}
    display_name: Binaries
```

Parameters:
* `aws_key`: your AWS key (use expansions to keep this a secret)
* `aws_secret`: your AWS secret (use expansions to keep this a secret)
* `local_file`: the local file to post
* `remote_file`: the ec2 path to post the file to
* `bucket`: the ec2 bucket to use
* `permissions`: the ec2 permissions string to upload with
* `content_type`: the MIME type of the file
* `display_name`: the display string for the file in the Evergreen UI

####gotest.parse
This command parses Go test results and sends them to the API server.
It accepts files generated by saving the output of the `go test -v` command to a file.

E.g. In a preceding shell.exec command, run  `go test -v > result.suite`

```yaml
- command: gotest.parse_files
  params: 
    files: ["src/*.suite"]
```

Parameters:
* `files`: a list of files (or blobs) to parse and upload

####attach.results
This command parses results in Evergreen's JSON test result format and posts them to the API server.

The format is as follows:
```json
{
    "results":[
    {
        "status":"pass",
            "test_file":"test_1",
            "exit_code":0,
            "elapsed":0.32200002670288086, //start - end
            "start":1398782500.359, //epoch time
            "end":1398782500.681 //epoch time
    },
    {
        "etc":"..."
    },
    ]
}
```

```yaml
- command: attach.results
  params:
    file_location: src/report.json
```

Parameters:
* `file_location`: a .json file to parse and upload


####attach.x_unit_results
This command parses results in the widely-used XUnit format and posts them to the API server.

```yaml
- command: attach.results
  params:
    file_location: src/results.xml
```

Parameters:
* `file_location`: a .xml file to parse and upload

### Build Variants
Build variants are a set of tasks run on a given platform. 
Each build variant has control over which tasks it runs, what distro it runs on, and what expansions it uses.

```yaml
buildvariants:
- name: osx-108
  display_name: OSX
  run_on:
  - localtestdistro
  expansions:
    test_flags: "blah blah"
  tasks:
  - name: compile
  - name: passing_test
  - name: failing_test
  - name: timeout_test
- name: ubuntu
  display_name: Ubuntu
  run_on:
  - ubuntu1404-test
  expansions:
    test_flags: "blah blah"
  tasks:
  - name: compile
  - name: passing_test
  - name: failing_test
  - name: timeout_test
```
Fields:
* `name`: an identification string for the variant
* `display_name`: how the variant is displayed in the Evergreen UI
* `run_on`: a list of acceptable distros to run the variant on (usually of length 1)
* `expansions`: a set of key-value expansion pairs
* `tasks`: a list of tasks to run

Additionally, an item in the `tasks` list can be of the form
```yaml
tasks:
- name: compile
- run_on: ubuntu1404-build
```
allowing tasks within a build variant to be run on different distros.
This is useful for optimizing tasks like compilations, that can benefit from larger, more powerful machines.

## Advanced Features

These features will help you do more complicated workloads with Evergreen.

### Pre, Post, and Timeout

All projects can have a `pre` and `post` field which define a list of command to run at the start and end of every task.
These are incredibly useful as a place for results commands or for `shell.track`/`shell.cleanup`.

```yaml
pre:
  - command: shell.track

post:
  - command: attach.results
    params:
      file_location: src/report.json
  - command: shell.cleanup
```

Additionally, project configs offer a hook for running command when a task times out,
allowing you to automatically run a debug script when something is stuck.

```yaml
timeout:
  - command: shell.exec
    params:
      working_dir: src
      script: |
        echo "Calling the hang analyzer..."
        python buildscripts/hang_analyzer.py
```

### Expansions

Expansions are variables within your config file. 
They take the form `${key_name}` within your project,
and are defined on a project-wide level on the project configuration page or on a build variant level within in the project.
They can be used an inputs to commands, including shell scripts.
```yaml
command: s3.get
   params:
     aws_key: ${aws_key}
     aws_secret: ${aws_secret}
```

Expansions can also take default arguments, in the form of `${key_name|default}`.
```yaml
 command: shell.exec
    params:
      working_dir: src
      script: |
        if [ ${has_pyyaml_installed|false} = false ]; then 
        ...
```
If an expansion is used in your project file, but is unset, it will be replaced with its default value.
If there is no default value, the empty string will be used.

### Functions
Functions offer a way to share commands across task definitions.
Functions are defined as follows:
```yaml
functions:
  "function name" :
    - command: my.command
    - command: my.command2
  "function name 2":
     command: single-command-not-in-a-list
```
They can be used anywhere a command can be used.

Functions can also optionally take arguments, in the form of.


### The Power of YAML
YAML as a format has some built-in support for defining variables and using them.
You might notice the use of node anchors and references in some of our project code.
For a quick example, see: http://en.wikipedia.org/wiki/YAML#Reference 

